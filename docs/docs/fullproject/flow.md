# 完整项目迁移方案

## 方案概览

[资源导出方案](../basic/flow.md) 提供了导出从 Unity 中导出 “资源” 的功能。而在 Unity 中 MonoBehaviour 也是挂载在 GameObject 上的一种资源。所以，我们在 [资源导出方案](../basic/flow.md) 的基础上，又做了脚本资源导出方案。

有了脚本资源导出能力，我们就可以针对整个 Unity 项目进行迁移导出，导出流程概览如下：
![流程概览](./image/overview.png)



## 底层原理

想要将 U3D 游戏适配到小游戏平台有两个难点：

- Unity 引擎本身的实现不开源，同时也不可能在微信客户端中直接集成 Unity 引擎；
- 基于 Unity 开发的游戏项目，脚本大多用 C# 实现，如果而小游戏平台是一个类 web 平台，需要使用 js 代码进行开发；

对于第一个问题，Unity 引擎不开源，所以我们没有办法去实现一个 js 版本的 Unity 引擎。

但是 Unity 中的 MonoBehaviour、Object、GameObject、Tramsform 等概念是通用的，我们可以在小游戏平台 js 中实现。也就是说，我们可以做一个 adaptor 层。当用户在调用 GameObject 的时候，经过 adaptor 将该调用桥接到小游戏提供的方法，那么小游戏平台里面不需要 Unity 引擎也可以复用 Unity 的脚本资源。

对于第二个问题，小游戏代码不支持 C#，我们需要将 C# 代码转换成 js。我们在 [Bridge.Net](https://bridge.net/) 的基础上，进行了修改，从而把 Unity 中的 C# 转换为 js。



这套思路落地成流程：

1. 使用Unity 插件，对美术资源和脚本资源进行导出，同时将脚本逻辑转换成 js
2. 将导出的所有资源和 adaptor 整合到小游戏目录，其中 adaptor 一方面是桥接层的代码，另一方面是运行时使用到的一些方法，比如 C# 的 System 库等。
3. 运行时，将脚本与 scene、prefab 进行绑定
4. 在微信开发者工具中运行 js 脚本，预览和运行 Unity 项目；



为了提供上述能力，本项目提供了一整套解决方案（微信小游戏 Unity 工具），从功能上分为三个部分：

- js adaptor：微信小游戏与 UnityEngine 组件之间的桥接适配层
- C# SDK：以 Unity 插件形式提供的 C# SDK，提供与 Unity 调用方式不一致的一系列调用接口 (要求对原始工程改造）；
- 场景和 Prefab 导出：场景及代码导出工具，可以将符合规范的 Unity 工程一键导出成微信小游戏工程（资源+代码导出插件）；



开发者需要关注两件事情：

1. 代码导出要求对原始工程进行一定的改造，如资源加载改成异步、一些第三方插件不能进行代码转换的要先屏蔽等；

2. 经过导出插件导出为小游戏工程之后需要在微信开发者工具里面进行二次开发，如添加小游戏相关的分享、排行榜能力，这部分需要按照微信方案的规范进行开发；

具体的项目改造可以参考`完整迁移方案参考`相关文档。


## 快速入门

上述方案具体的工作流可以参考[quickstart](./quickstart.md)。

